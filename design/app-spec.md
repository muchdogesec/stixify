## Overview

This general app flow looks as follows;

<iframe width="768" height="432" src="https://miro.com/app/live-embed/uXjVKD2mg_0=/?moveToViewport=-1578,-1466,5048,2431&embedId=203387944927" frameborder="0" scrolling="no" allow="fullscreen; clipboard-read; clipboard-write" allowfullscreen></iframe>

### Profiles

A profile is created by a staff user in the Django staff interface. It consists of a:

* id: autogenerated
* created date: autogenerated
* name: to identify profile/use for extractions
* extractions: list of 0 or more extractions (via txt2stix api) to applied when profile run
* whitelists: list of 0 or more whitelists (via txt2stix api) to applied when profile run
* aliases: list of 0 or more aliases (via txt2stix api) to applied when profile run
* relationship mode: the relationship mode to be used with txt2stix

A profile cannot be modified or deleted.

### A short note on file2txt

Stixify supports filetypes that match file2txt.

file2txt can be found here:

https://github.com/signalscorps/file2txt

file2txt is run with the following settings;

```shell
python3 file2txt.py \
    --mode '<MODE>' \
    --input_filepath '<FILE>' \
    --output_filename '<DOC>' \
    --defang true \
    --extract_text_from_image true \
    --ai_prettify true
```

Because `ai_prettify` is used, you will need to set OpenAI keys in `.env` file.

Stixify validates all files before they are processed (check mime-types), this offers better user experience but also enhances security.

### A short note on txt2stix

A lot of the functionality of Stixify uses the txt2stix library under the hood to work with the markdown generated by file2txt. txt2stix can be found here;

https://github.com/muchdogesec/txt2stix

Thus as the txt2stix code is updated (and pulled onto server), the options avaiable to staff should automatically reflect any changes (e.g. if new Extraction is added to the main txt2stix repository, staff should see this in the staff UI).

The command run for txt2stix for each post is as follows;

```shell
python3 txt2stix.py \
    --relationship_mode '<SET IN PROFILE BY STAFF IN STAFF INTERFACE>' \
    --input_file '<MARKDOWN FILE AS CONVERTED BY FILE2TXT>' \
    --name '<ENTERED AT CLI>' \
    --labels '<ENTERED AT CLI>' \
    --tlp_level '<ENTERED AT CLI>' \
    --confidence '<ENTERED AT CLI>' \
    --identity '<ENTERED AT CLI>' \
    --use_extractions '<SET IN PROFILE BY STAFF IN STAFF INTERFACE>' \
    --use_aliases '<SET IN PROFILE BY STAFF IN STAFF INTERFACE>' \
    --use_whitelists '<SET IN PROFILE BY STAFF IN STAFF INTERFACE>' \
```

## REST API

### Authentication

Requests don't require any credentials as it is assumed user will be running server privately.

### Schema

To make it easy for users to get up and running, we should build the API against the OpenAPI v3 spec (https://spec.openapis.org/oas/v3.1.0). We can then use Swagger (https://swagger.io/resources/open-api/) to automatically deliver a lightweight view to allow users to interact with the API in the browser.

### Pagination

We should add an `.env` variable that allows user to set max record returned per page.

All paginated responses should contain the header;

```json
{
    "page_number": "<NUMBER>",
    "page_size": "<SET IN ENV>",
    "page_results_count": "<COUNT OF RESULTS ON PAGE>",
    "total_results_count": "<COUNT OF RESULTS ON ALL PAGES>",
```

### Endpoints

#### txt2stix details

##### Get profiles

See Obstracts

##### Get profile

See Obstracts

##### Get Extractions

See Obstracts

##### Get Extraction

See Obstracts

##### Get Whitelists

See Obstracts

##### Get Whitelist

See Obstracts

##### Get Aliases

See Obstracts

##### Get Alias

See Obstracts

#### Groupings

Groupings are groups of STIX Reports. e.g a user could create a Grouping "all reports related to APT1"

Groupings are represented as STIX 2.1 Grouping objects when created;

```json
{
    "type": "grouping",
    "spec_version": "2.1",
    "id": "grouping--<UUIDV5>",
    "created_by_ref": "<IDENTITY USED ON CREATION>",
    "created": "<DATE GROUPING WAS CREATED>",
    "modified": "<DATE GROUPING WAS LAST UPDATED>",
    "name": "<ENTERED BY USER AT INPUT>",
    "description": "<ENTERED BY USER AT INPUT>",
    "labels": "<ENTERED BY USER AT INPUT>",
    "context": "<ENTERED BY USER AT INPUT>",
    "object_refs": [
        "<IDENTITY USED ON CREATION>" // can never be removed as at least one value is required for this key
        "<REPORT OBJECTS FOR FILES IN GROUPING>"
    ],
    "object_marking_refs": [
        "marking-definition--<TLP LEVEL SET>",
        "marking-definition--e92c648d-03eb-59a5-a318-9a36e6f8057c"
    ]
}
```

The UUID of the grouping object on creation is generated by namespace `e92c648d-03eb-59a5-a318-9a36e6f8057c` and value `created_by_ref+created`

As new objects are added/removed or details about the Grouping changes, the `modified` time changes.

##### POST Create a Grouping

```shell
POST HOST/api/VERSION/groupings/
```

The body of the request should contain;

```json
{
  "name": "<value>", // REQUIRED
  "description": "<value>", // REQUIRED
  "tlp_level": "<value>", // txt2stix setting (value CLEAR, GREEN, AMBER, AMBER+STRICT, RED allowed) // REQUIRED, DEFAULT IS RED
  "labels": ["<value1","value2"], // OPTIONAL
  "identity": "{<identity.json>}", // identity.json will be validated is valid identity, else error will be returned // OPTIONAL, DEFAULT IS STIXIFY IDENTITY
  "context": "<VALUE>", // either suspicious-activity, malware-analysis, or unspecified
  "report_ids": ["report--1","report--2"] // STIX REPORT URLS for FILES // OPTIONAL
}
```

A 200 response will return;

```json
{
    "groupings": [
        {
            "type": "grouping",
            "spec_version": "2.1",
            "id": "grouping--<UUIDV5>",
            "created_by_ref": "<IDENTITY USED ON CREATION>",
            "created": "<DATE GROUPING WAS CREATED>",
            "modified": "<DATE GROUPING WAS LAST UPDATED>",
            "name": "<ENTERED BY USER AT INPUT>",
            "description": "<ENTERED BY USER AT INPUT>",
            "labels": [
                "<ENTERED BY USER AT INPUT>"
            ],
            "context": "<ENTERED BY USER AT INPUT>",
            "object_refs": [
                "<IDENTITY USED ON CREATION>"
                "<REPORT OBJECTS FOR FILES IN GROUPING>"
            ],
            "object_marking_refs": [
                "marking-definition--<TLP LEVEL SET>",
                "marking-definition--e92c648d-03eb-59a5-a318-9a36e6f8057c"
            ]
        }
    ]
}
```

##### GET Groupings

```shell
GET HOST/api/VERSION/groupings/
```

Accepts URL parameters

* `name` (optional): search name values as wildcard
* `labels` (optional): search name values as wildcard
* `tlp_level` (optional): either CLEAR, GREEN, AMBER+STRICT, AMBER, RED
* `created_by_ref` (optional): one or more `identity--` refs. treated as OR
* `context` (optional): either suspicious-activity, malware-analysis, or unspecified
* `page_size` (max is 50, default is 50)
* `page`
    * default is 0
* `sort`:
    * modified_ascending
    * modified_descending (default)
    * created_ascending
    * created_descending
    * name_ascending
    * name_descending

A 200 response returns

```json
{
    "page_size": "<value>",
    "page_number": "<value>",
    "page_results_count": "<value>",
    "total_results_count": "<value>",
    "groupings": [
        "MATCHING GROUPING OBJECTS"
    ]
}
```

##### GET a Grouping by ID

```shell
GET HOST/api/VERSION/groupings/{grouping_id}
```

A 200 response will return;

```json
{
    "groupings": [
        "GROUPING OBJECT"
    ]
}
```

##### PATCH Update a Grouping

```shell
PATCH HOST/api/VERSION/groupings/
```

The body of the request should contain;

```json
{
  "name": "<value>", // REQUIRED
  "description": "<value>", // REQUIRED
  "tlp_level": "<value>", // txt2stix setting (value CLEAR, GREEN, AMBER, AMBER+STRICT, RED allowed) // REQUIRED, DEFAULT IS RED
  "labels": ["<value1","value2"], // OPTIONAL
  "report_ids": ["report--1","report--2"] // STIX REPORT URLS for FILES, MUST PASS ALL OBJECTS EACH TIME // OPTIONAL
}
```

#### Files

Files are uploaded. Uploaded files create Reports (if successfully processed)

##### POST Upload a file

```shell
POST HOST/api/VERSION/files/
```

The file should be posted as `form-data`.

The file mimetype will be validated before file is processed by the server. If mimetype does not match supported value by file2txt will result in error.

```json
{
  "mode": "<value>", // file2txt setting (this is a secondary validation) // REQUIRED
  "defang": "<boolean>", // file2txt setting // OPTIONAL, DEFAULT IS TRUE
  "extract_text_from_image": "<boolean>", // file2txt setting // OPTIONAL, DEFAULT IS FALSE
  "relationship_mode": "<value>", // txt2stix setting (value standard or ai) // OPTIONAL, DEFAULT IS STANDARD
  "name": "<value>", // txt2stix setting // REQUIRED
  "tlp_level": "<value>", // txt2stix setting (value CLEAR, GREEN, AMBER, AMBER+STRICT, RED allowed) // REQUIRED, DEFAULT IS RED
  "confidence": "<value>", // txt2stix setting (value between 0-100 allowed) // OPTIONAL, DEFAULT IS 0
  "labels": ["<value1","value2"], // txt2stix setting // OPTIONAL
  "identity": "{<identity.json>}", // txt2stix setting (will be validated is valid identity, else error will be returned) // OPTIONAL, DEFAULT IS STIXIFY IDENTITY
  "profile_id": "<PROFILE ID>", // REQUIRED
  "grouping_id": "<GROUPING ID>" // OPTIONAL GROUPING OUTPUT REPORT SHOULD BE ADDED TO
}
```

Will return a 200 response

```json
{
    "files": [
        {
            "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
            "job_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
            "file_name": "string",
            "file_mimetype": "string",
            "file_size": "string",
            "file_download_url": "string",
        }
    ]
}
```

##### GET Files

```shell
GET HOST/api/VERSION/files/
```

Accepts URL parameters

* `report_id` (optional): search by report IDs
* `page_size` (max is 50, default is 50)
* `page`
    * default is 0
* `sort`:
    * modified_ascending
    * modified_descending (default)
    * created_ascending
    * created_descending
    * name_ascending
    * name_descending

A 200 response returns

```json
{
    "page_size": "<value>",
    "page_number": "<value>",
    "page_results_count": "<value>",
    "total_results_count": "<value>",
    "files": [
        "MATCHING FILE RECORDS"
    ]
}
```
##### GET File by ID

```shell
GET HOST/api/VERSION/files/{id}
```

```json
{
    "files": [
        "FILE RECORD"
    ]
}
```

#### Jobs

##### GET jobs

```shell
GET HOST/api/VERSION/jobs/
```

Accepts URL parameters:

* `file_id`
* `report_id`
* `page_size` (max is 50, default is 50)
* `page`
    * default is 0
* `sort`:
    * run_datetime_ascending
    * run_datetime_descending (default)
    * state_ascending
    * state_descending

```json
{
    "page_size": "<value>",
    "page_number": "<value>",
    "page_results_count": "<value>",
    "total_results_count": "<value>",
    "jobs": [
        {
            "id": "<value>",
            "count_of_objects_created": "<value>",
            "file_id": "<value>",
            "report_id": "<value>",
            "mode": "<value>",
            "defang": "<boolean>",
            "extract_text_from_image": "<boolean>",
            "relationship_mode": "<value>",
            "name": "<value>",
            "tlp_level": "<value>",
            "confidence": "<value>",
            "labels": ["<value1","value2"],
            "identity": "{<identity.json>}",
            "profile_id": "<PROFILE ID>",
            "grouping_id": "<GROUPING ID>",
            "state": "pending",
            "run_datetime": "2024-07-18T11:36:50.368Z",
            "info": "string"
        }
    ]
}
```

##### GET job by ID

```shell
GET HOST/api/VERSION/jobs/{id}/
```

```json
{
    "jobs": [
        {
            "id": "<value>",
            "count_of_objects_created": "<value>",
            "file_id": "<value>",
            "report_id": "<value>",
            "mode": "<value>",
            "defang": "<boolean>",
            "extract_text_from_image": "<boolean>",
            "relationship_mode": "<value>",
            "name": "<value>",
            "tlp_level": "<value>",
            "confidence": "<value>",
            "labels": ["<value1","value2"],
            "identity": "{<identity.json>}",
            "profile_id": "<PROFILE ID>",
            "grouping_id": "<GROUPING ID>",
            "state": "pending",
            "run_datetime": "2024-07-18T11:36:50.368Z",
            "info": "string"
        }
    ]
}
```

#### Reports

##### GET reports

```shell
GET HOST/api/VERSION/jobs/reports/
```

Accepts URL parameters

* `name` (optional): search name values as wildcard
* `labels` (optional): search name values as wildcard
* `tlp_level` (optional): either CLEAR, GREEN, AMBER+STRICT, AMBER, RED
* `created_by_ref` (optional): one or more `identity--` refs. treated as OR
* `confidence` (optional): between 0-100
* `grouping_id` (optional): one or more `grouping--` refs. treated as OR
* `page_size` (max is 50, default is 50)
* `page`
    * default is 0
* `sort`:
    * modified_ascending
    * modified_descending (default)
    * created_ascending
    * created_descending
    * name_ascending
    * name_descending

```json
{
    "page_size": "<value>",
    "page_number": "<value>",
    "page_results_count": "<value>",
    "total_results_count": "<value>",
    "reports": [
        "MATCHING STIX REPORT OBJECTS"
    ]
}
```

##### GET report

```shell
GET HOST/api/VERSION/jobs/reports/{id}/
```

```json
{
    "page_size": "<value>",
    "page_number": "<value>",
    "page_results_count": "<value>",
    "total_results_count": "<value>",
    "objects": [
        "ALL STIX OBJECTS EXTRACTED FOR REPORT INC REPORT"
    ]
}
```

##### DELETE report

Will also delete corresponding file from the system.

```shell
DELETE HOST/api/VERSION/jobs/reports/{id}/
```

Successful response will return an empty 200 response.

#### STIX Objects

Allows user to search posts using STIX objects as the starting point.

##### GET STIX objects (SCO)

```shell
GET HOST/api/VERSION/objects/scos/
```

Note, this endpoint only searches SCO objects (as SCOs are observables / indicators of compromise). The only SCOs that can be created by txt2stix are as follows;

* `ipv4-addr`
    * value field = `value`
* `network-traffic`
    * This type has no relevant value field, so not used
* `ipv6-addr`
    * value field = `value`
* `domain-name`
    * value field = `value`
* `url`
    * value field = `value`
* `file`
    * value field = `name`
    * value field = `hashes[]`
* `directory`
    * value field = `path`
* `email-addr`
    * value field = `value`
* `mac-addr`
    * value field = `value`
* `windows-registry-key`
    * value field = `key`
* `autonomous-system`
    * value field = `number`
* `user-agent`
    * value field = `string`
* `cryptocurrency-wallet`
    * value field = `address`
* `cryptocurrency-transaction`
    * value field = `hash`
    * value field = `symbol`
* `bank-card`
    * value field = `number`
* `bank-account`
    * value field = `iban_number`
* `phone-number`
    * value field = `number`

Note the value field mapping is designed to show the field user will be most interested in (and thus what we expose for a user to search). e.g. for IP address, a user most wants the actual IP address (e.g. 1.1.1.1) whichy is held in the `value` property of the `ipv4-addr` object.

Accepts URL parameters;

* `types` (dictionary of STIX object types, shown above): allows results to be filtered on `data.type`
    * default: none
    * required: false
* `value` (string): searches through the value fields shown mapped above. Is wildcard search.
    * default: none
    * required: false
* `post_id`: allows results to be filtered using a post id
    * default: none
    * required: false
* `page`
    * default is 0
* `sort`:
    * type_descending (default)
    * type_ascending

```json
{
    "objects": [
        "<PRINT ENTIRE LIST OF STIX OBJECTS MATCHING FILTERS>"
    ]
}
```

##### GET STIX object (SCO)

```shell
GET HOST/api/VERSION/objects/scos/:sco_id/
```

```json
{
    "objects": [
        "<PRINT STIX OBJECT>"
    ]
}
```

##### GET STIX objects (SDO)

```shell
GET HOST/api/VERSION/objects/sdos/
```

Note, this endpoint only searches SDO objects. The only SDOs that can be created by txt2stix are as follows;

* `report`
* `notes` (these only represent processing information)
* `indicator`
* `attack-pattern`
* `weakness`
* `campaign`
* `course-of-action`
* `infrastructure`
* `intrusion-set`
* `malware`
* `threat-actor`
* `tool`
* `identity` (includes both extractions and auto-imported identities)
* `location` 

The endpoint accepts the following URL parameters;

* `hide_processing_notes` (boolean): allows results to be filtered to remove Note objects
    * default: false
    * required: false
* `type` (dictionary of STIX object types, shown above): allows results to be filtered on `data.type`
    * default: none
    * required: false
* `name` (string): allows results to be filtered on the name field. Is wildcard search.
    * default: none
    * required: false
* `labels` (string): allows results to be filtered on items in the string field. Is wildcard search.
    * default: none
    * required: false
* `post_id`: allows results to be filtered using a post id
    * default: none
    * required: false
* `page`
    * default is 0
* `sort`:
    * type_descending
    * type_ascending
    * modified_ascending
    * modified_descending (default)
    * created_ascending
    * created_descending
    * name_ascending
    * name_descending

```json
{
    "objects": [
        "<PRINT ENTIRE LIST OF STIX OBJECTS MATCHING FILTERS>"
    ]
}
```

##### GET STIX object (SDO)

```shell
GET HOST/api/VERSION/objects/sdos/:sdo_id
```

```json
{
    "objects": [
        "<PRINT STIX OBJECT>"
    ]
}
```

##### GET STIX objects (SRO)

```shell
GET HOST/api/VERSION/objects/sros/
```

This endpoint is useful for finding relationships between objects


* `source_ref` (stix id): filter SROs using `source_ref`
    * default: none
    * required: false
* `source_ref_type` (stix type): filter source objects by type
    * default: none
    * required: false
* `target_ref` (stix id): filter SROs using `target_ref`
    * default: none
    * required: false
* `target_ref_type` (stix type): filter target objects by type
    * default: none
    * required: false
* `relationship_type` (string): allows results to be filtered on the relationship_type field. Is wildcard search.
    * default: none
    * required: false
* `page`
    * default is 0
* `sort`:
    * type_descending
    * type_ascending
    * modified_ascending
    * modified_descending (default)
    * created_ascending
    * created_descending
    * name_ascending
    * name_descending

##### GET STIX object (SRO)

```shell
GET HOST/api/VERSION/objects/sros/:sro_id
```

```json
{
    "objects": [
        "<PRINT STIX OBJECT>"
    ]
}
```

### Errors

Bad parameters / bad request format;

```json
{
    "message": " The server did not understand the request",
    "code": 400
}
```

Endpoint / file / report / job / object does not exist

```json
{
    "message": " The server cannot find the resource you requested",
    "code": 404
}
```

Bad file / does not match mimetype

```json
{
    "message": " The file you are attempting upload is not supported",
    "code": 406
}
```